<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>XeTeX basic example</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css" media="screen">
        .container {
            margin: 20px;
            width: 100%;
            display: flex;
            flex-direction: row;
            min-height: 600px;
        }
        .editor, .pdfbox {
            width: 50%;
            height: 400px;
        }
        pre {
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: scroll;
        }
    </style>
</head>
<body class="code-snippets-visible">

<h4>Upload your LaTeX dataset folder (.tex + .jpg files):</h4>
<input type="file" id="datasetInput" webkitdirectory directory multiple><br><br>

<button type="button" onclick="createFormat()">Create Format</button>
<button type="button" onclick="compile()" id="compilebtn" disabled>Initializing</button>
<button id="downloadBtn">Download PDF</button>

<div class="container" id="demo">
    <div class="editor" id="editor">
        <div id="editor">
\documentclass{article}
\usepackage{graphicx}
\begin{document}
Hello World!
\end{document}
        </div>
    </div>
    <div class="pdfbox" id="pdfbox"></div>
</div>

<h4>Console Output:</h4>
<pre id="console"></pre>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="PdfTeXEngine.js"></script>

<script>
    const compileBtn = document.getElementById("compilebtn");
    const consoleOutput = document.getElementById("console");
    const pdfbox = document.getElementById("pdfbox");
    const datasetInput = document.getElementById("datasetInput");

    const editor = ace.edit("editor");
    editor.setTheme("ace/theme/Chrome");
    editor.session.setMode("ace/mode/latex");
    editor.session.setUseWrapMode(true);
    editor.setFontSize(18);

    const globalEn = new PdfTeXEngine();

    let uploadedImages = {};
    let mainTexFileName = "";

    datasetInput.addEventListener("change", async function () {
        const files = Array.from(this.files);
        uploadedImages = {};
        mainTexFileName = "";

        const readPromises = files.map((file) => {
            return new Promise((resolve) => {
                const name = file.name;
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (name.endsWith(".tex")) {
                        mainTexFileName = name;
                        editor.setValue(e.target.result);
                    } else if (name.endsWith(".jpg")) {
                        const img = new Image();
                        const objectUrl = URL.createObjectURL(file);

                        img.onload = () => {
                        const width = img.width;
                        const height = img.height;
                        URL.revokeObjectURL(objectUrl); // cleanup
                        // console.log('name:'+ name, 'Width: '+ width, 'height:' + height);
                        // resolve({ width, height });
                        };
                        uploadedImages[name] = new Uint8Array(e.target.result);
                    }
                    resolve();
                };
                if (name.endsWith(".tex")) reader.readAsText(file);
                else reader.readAsArrayBuffer(file);
            });
        });

        await Promise.all(readPromises);

        if (!mainTexFileName) {
            alert("No .tex file found.");
        }
    });


    async function init() {
        await globalEn.loadEngine();
        compileBtn.innerHTML = "Compile";
        compileBtn.disabled = false;
    }

    async function createFormat() {
        try {
            await globalEn.compileFormat();
            console.log("Format created successfully.");
        } catch (error) {
            console.error("Error creating format: ", error);
        }
    }

    async function compile() {
        if (!globalEn.isReady()) {
            console.log("pdfTeX Engine not ready yet");
            return;
        }

        compileBtn.disabled = true;
        compileBtn.innerHTML = "Compiling...";

        // If no file is selected, use default filename and compile the editor content
        const fileNameToUse = mainTexFileName || "main.tex";
        
        globalEn.writeMemFSFile(fileNameToUse, editor.getValue());
        globalEn.setEngineMainFile(fileNameToUse);

        for (let [filename, data] of Object.entries(uploadedImages)) {
            globalEn.writeMemFSFile(filename, data);
        }

        let r = await globalEn.compileLaTeX();
        consoleOutput.innerHTML = r.log;
        compileBtn.innerHTML = "Compile";
        compileBtn.disabled = false;

        if (r.status === 0 || r.status === 1) {
            const pdfblob = new Blob([r.pdf], {type : 'application/pdf'});
            const objectURL = URL.createObjectURL(pdfblob);
            setTimeout(()=>{
                URL.revokeObjectURL(objectURL);
            }, 30000);
            console.log(objectURL);
            pdfbox.innerHTML = `<embed src="${objectURL}" width="100%" height="400px" type="application/pdf">`;

            // Add an event listener to the download button
            document.getElementById("downloadBtn").addEventListener("click", () => {
                const downloadLink = document.createElement("a");
                downloadLink.href = objectURL;
                downloadLink.download = "main.pdf";
                downloadLink.click();
            });
        }
    }

    init();
</script>
</body>
</html>